name: Advanced Docker Health Check

on: 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  advanced-health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Build Docker image
        run: |
          echo "::group::ðŸ³ Building Docker Image"
          docker build -t flask-app .
          echo "::endgroup::"
          
      - name: Start server with health check
        run: |
          echo "::group::ðŸš€ Starting Server"
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ healthcheck
          docker run -d \
            --name flask-server \
            --health-cmd="curl -f http://localhost:5000/ || exit 1" \
            --health-interval=5s \
            --health-timeout=3s \
            --health-retries=3 \
            -p 5000:5000 \
            flask-app
          
          echo "â³ Waiting for server to be healthy..."
          timeout 30s bash -c 'until docker inspect --format="{{.State.Health.Status}}" flask-server | grep -q "healthy"; do sleep 2; done' || true
          
          echo "ðŸ“Š Container health status:"
          docker inspect --format="{{.State.Health.Status}}" flask-server
          echo "::endgroup::"
          
      - name: Run comprehensive tests
        run: |
          echo "::group::ðŸ§ª Running Comprehensive Tests"
          
          # Test 1: Basic connectivity
          echo "ðŸ“¡ Testing basic connectivity..."
          if python client_colored.py; then
            echo "::notice title=Connectivity Test::âœ… Basic connectivity test passed"
          else
            echo "::error title=Connectivity Test::âŒ Basic connectivity test failed"
            exit 1
          fi
          
          # Test 2: Response content validation
          echo "ðŸ” Testing response content..."
          RESPONSE=$(curl -s http://localhost:5000/)
          if [[ "$RESPONSE" == *"Hello, World!"* ]]; then
            echo "::notice title=Content Test::âœ… Response content is correct"
            echo "ðŸ“„ Response: $RESPONSE"
          else
            echo "::error title=Content Test::âŒ Response content is incorrect: $RESPONSE"
            exit 1
          fi
          
          echo "::endgroup::"
          
      - name: Final success message
        if: success()
        run: |
          echo "::notice title=All Health Checks Passed::ðŸŽ‰ ${OK}DOCKER HEALTH CHECK COMPLETED SUCCESSFULLY${RST}"
          echo "âœ… Server is running correctly in Docker"
          echo "âœ… All connectivity tests passed"
          echo "âœ… Response content is valid"
          
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up containers..."
          docker stop flask-server 2>/dev/null || true
          docker rm flask-server 2>/dev/null || true